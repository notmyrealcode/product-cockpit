# M1 + M2 Design: Core Task Management & MCP Integration

## Overview

Build a VS Code extension with TreeView-based task management and MCP server for Claude Code integration. Cross-platform, native VS Code APIs only.

## Project Structure

```
product-cockpit/
├── src/
│   ├── extension.ts          # Activation, commands, initialization
│   ├── tasks/
│   │   ├── TaskProvider.ts   # TreeDataProvider for task list
│   │   ├── TaskItem.ts       # TreeItem subclass
│   │   ├── TaskStore.ts      # Read/write tasks.json, file watcher
│   │   └── types.ts          # Task interface, Status enum
│   ├── mcp/
│   │   └── server.ts         # MCP server template (bundled)
│   ├── http/
│   │   └── bridge.ts         # HTTP server for MCP communication
│   └── init/
│       └── initialize.ts     # First-run setup dialog & file creation
├── package.json              # Extension manifest
├── tsconfig.json
└── .vscodeignore
```

## Data Flow

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   TreeView UI   │────▶│   TaskStore     │◀────│   MCP Server    │
│  (TaskProvider) │     │  (single source │     │  (Claude Code)  │
└─────────────────┘     │   of truth)     │     └─────────────────┘
                        └────────┬────────┘
                                 │
                                 ▼
                        .pmcockpit/tasks.json
```

**TaskStore:**
- Loads tasks from `tasks.json` on activation
- Methods: `getTasks()`, `addTask()`, `updateTask()`, `deleteTask()`, `reorderTask()`
- Emits `onDidChange` event — TreeView subscribes to refresh
- Watches `tasks.json` for external edits
- Atomic writes: temp file + rename

**Drag-to-reorder:**
- TreeView `TreeDragAndDropController`
- Priority implicit from array order (index 0 = highest)

## MCP Integration

```
┌──────────────────┐         ┌──────────────────┐
│  VS Code Ext     │◀──HTTP──│  MCP Server      │
│  (TaskStore +    │  :0     │  (.pmcockpit/    │
│   HTTP server)   │─────────▶  mcp-server.js)  │
└──────────────────┘         └──────────────────┘
                                    ▲
                                    │ stdio
                                    ▼
                             ┌──────────────────┐
                             │  Claude Code     │
                             └──────────────────┘
```

Extension starts localhost HTTP server on random port, writes to `.pmcockpit/.port`. MCP server reads port, proxies tool calls.

**MCP Tools → HTTP endpoints:**
- `get_next_task` → GET `/tasks/next`
- `get_task` → GET `/tasks/:id`
- `update_task_status` → PATCH `/tasks/:id/status`
- `create_task` → POST `/tasks`
- `list_requirements` → GET `/requirements`
- `get_requirements_path` → GET `/requirements/path`
- `get_task_requirement` → GET `/tasks/:id/requirement`
- `create_requirement` → POST `/requirements`
- `complete_interview` → POST `/interview/complete`

## Initialization Flow

1. Extension checks for `.pmcockpit/tasks.json`
2. If missing, show modal: Initialize/Cancel
3. On Initialize:
   - Create `.pmcockpit/tasks.json`
   - Create `docs/requirements/`
   - Merge into `.claude/settings.json` (tool permissions)
   - Merge into `.claude/mcp.json` (server config)
   - Write `.pmcockpit/mcp-server.js`
4. On Cancel: extension dormant, no sidebar

**Sidebar visibility:** `when: pmcockpit.initialized` context

## Commands

| Command | Trigger | Action |
|---------|---------|--------|
| `pmcockpit.addTask` | Header + button | Input box → create task |
| `pmcockpit.editTask` | Right-click | Input box → update description |
| `pmcockpit.setStatus` | Right-click | Quick pick → update status |
| `pmcockpit.deleteTask` | Right-click | Confirm → delete |
| `pmcockpit.initialize` | Command palette | Run init flow |

Drag-drop reordering via `TreeDragAndDropController`.
